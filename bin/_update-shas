#!/bin/sh

set -euo pipefail

file="configuration.nix"
channel=$(grep '^  channel = "' "$file" | awk -F\" '{print $2}')
if [ -z "$channel" ]; then
    echo "Error: NixOS channel not found in $file."
    exit 1
fi
echo "The current NixOS channel is ${channel}."

echo
echo "Old sha256 sums:"

extract_sha() {
    grep -A 2 "$1" "$file" | grep 'sha256' | awk -F\" '{print $2}'
}

old_nixpkgs_sha=$(extract_sha 'nixpkgs-source =')
old_homemanager_sha=$(extract_sha 'home-manager =')

if [ -z "$old_nixpkgs_sha" ] || [ -z "$old_homemanager_sha" ]; then
    echo "Error: Failed to extract old sha256 sums."
    exit 1
fi

echo "nixpkgs sha256: $old_nixpkgs_sha"
echo "homemanager sha256: $old_homemanager_sha"

echo
echo "Fetching new sha256 sums..."

fetch_new_sha() {
    local url=$1
    local sha
    sha=$(
        curl -s "$url" |
        awk '/"sha":/ { gsub(/"/, "", $2); gsub(/,/, "", $2); print $2; exit; }'
    )
    if [ -z "$sha" ]; then
        echo "Error: Failed to fetch new sha256 sum for $url."
        exit 1
    fi
    echo "$sha"
}

new_nixpkgs_sha=$(fetch_new_sha "https://api.github.com/repos/NixOS/nixpkgs/commits?sha=nixos-$channel")
new_homemanager_sha=$(fetch_new_sha "https://api.github.com/repos/nix-community/home-manager/commits?sha=release-$channel")

echo "New sha256 sums:"
echo "nixpkgs sha256: $new_nixpkgs_sha"
echo "homemanager sha256: $new_homemanager_sha"

echo
echo "Replacing old sums with new sums..."

replace_sha() {
    local old_sha=$1
    local new_sha=$2
    # Using Perl for in-place editing to address portability
    perl -pi -e "s/\Q$old_sha\E/$new_sha/g" "$file"
}

replace_sha "$old_nixpkgs_sha" "$new_nixpkgs_sha"
replace_sha "$old_homemanager_sha" "$new_homemanager_sha"

# Verify replacements
new_file_nixpkgs_sha=$(extract_sha 'nixpkgs-source =')
new_file_homemanager_sha=$(extract_sha 'home-manager =')

if [ "$new_file_nixpkgs_sha" != "$new_nixpkgs_sha" ] || [ "$new_file_homemanager_sha" != "$new_homemanager_sha" ]; then
    echo "Error: Failed to correctly replace sha256 sums in $file."
    exit 1
fi

echo "Successfully replaced old sha256 sums with new ones."
